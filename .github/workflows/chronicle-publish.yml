name: Publish Chronicle

on:
  workflow_dispatch:
    inputs:
      force:
        description: 'Force regenerate all images (use for fixing existing images)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  push:
    branches: [main]
    paths:
      - "chronicle/**"

jobs:
  publish:
    runs-on: ubuntu-latest
    name: Publish Chronicle to qino Chronicles
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish to backend
        env:
          BACKEND_URL: https://qino-chronicles-backend.philhradecs.workers.dev
          PUBLISH_API_KEY: ${{ secrets.CHRONICLE_PUBLISH_KEY }}
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          CHRONICLE_PATH="chronicle"
          FORCE_FLAG="${{ inputs.force || 'false' }}"
          if [ -z "$FORCE_FLAG" ]; then FORCE_FLAG="false"; fi
          PAYLOAD_FILE=$(mktemp)
          export REPO_NAME CHRONICLE_PATH FORCE_FLAG PAYLOAD_FILE

          python <<'PY'
          import json, os
          from pathlib import Path

          repo_name = os.environ["REPO_NAME"]
          chronicle_path = Path(os.environ.get("CHRONICLE_PATH", "chronicle"))
          payload_file = Path(os.environ["PAYLOAD_FILE"])
          force_flag = os.environ.get("FORCE_FLAG", "false").lower() == "true"

          def read_text(path: Path) -> str:
              return path.read_text() if path.is_file() else ""

          payload = {
              "repoName": repo_name,
              "world": read_text(chronicle_path / "world.md"),
              "theme": read_text(chronicle_path / "theme.md"),
              "arcs": read_text(chronicle_path / "arcs.md"),
              "force": force_flag,
          }

          manifest_path = chronicle_path / "manifest.json"
          if manifest_path.is_file():
              try:
                  payload["manifest"] = json.loads(manifest_path.read_text())
              except Exception:
                  payload["manifest"] = None
          else:
              payload["manifest"] = None

          chapters_dir = chronicle_path / "chapters"
          chapters = []
          if chapters_dir.is_dir():
              for chapter_dir in sorted(chapters_dir.iterdir()):
                  if not chapter_dir.is_dir():
                      continue
                  chapter_file = chapter_dir / "chapter.md"
                  if not chapter_file.is_file():
                      continue

                  chapter = {
                      "slug": chapter_dir.name,
                      "content": chapter_file.read_text(),
                  }
                  world_snapshot = chapter_dir / "world.md"
                  arcs_snapshot = chapter_dir / "arcs.md"
                  if world_snapshot.is_file():
                      chapter["worldSnapshot"] = world_snapshot.read_text()
                  if arcs_snapshot.is_file():
                      chapter["arcsSnapshot"] = arcs_snapshot.read_text()
                  chapters.append(chapter)

          payload["chapters"] = chapters

          payload_file.write_text(json.dumps(payload))
          print(f"Built payload with {len(chapters)} chapters (force: {force_flag}) -> {payload_file}")
          PY

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BACKEND_URL/publish" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PUBLISH_API_KEY" \
            -d @"$PAYLOAD_FILE")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully published chronicle"
          else
            echo "Failed to publish chronicle (HTTP $HTTP_CODE)"
            exit 1
          fi
