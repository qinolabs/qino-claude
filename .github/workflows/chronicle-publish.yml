name: Publish Chronicle

on:
  workflow_dispatch:
    inputs:
      force:
        description: 'Force regenerate all images (use for fixing existing images)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  push:
    branches: [main]
    paths:
      - "chronicle/**"

jobs:
  publish:
    runs-on: ubuntu-latest
    name: Publish Chronicle to qino Chronicles
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish to backend
        env:
          BACKEND_URL: https://qino-chronicles-backend.philhradecs.workers.dev
          PUBLISH_API_KEY: ${{ secrets.CHRONICLE_PUBLISH_KEY }}
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          CHRONICLE_PATH="chronicle"

          # Read world.md, theme.md, and arcs.md
          WORLD_CONTENT=""
          THEME_CONTENT=""
          ARCS_CONTENT=""
          if [ -f "$CHRONICLE_PATH/world.md" ]; then
            WORLD_CONTENT=$(cat "$CHRONICLE_PATH/world.md")
          fi
          if [ -f "$CHRONICLE_PATH/theme.md" ]; then
            THEME_CONTENT=$(cat "$CHRONICLE_PATH/theme.md")
          fi
          if [ -f "$CHRONICLE_PATH/arcs.md" ]; then
            ARCS_CONTENT=$(cat "$CHRONICLE_PATH/arcs.md")
          fi

          # Read manifest.json if it exists
          MANIFEST_JSON="null"
          if [ -f "$CHRONICLE_PATH/manifest.json" ]; then
            MANIFEST_JSON=$(cat "$CHRONICLE_PATH/manifest.json")
          fi

          # Build chapters array by reading each chapter file
          CHAPTERS_JSON="[]"
          for chapter_file in "$CHRONICLE_PATH/chapters"/*.md; do
            if [ -f "$chapter_file" ]; then
              slug=$(basename "$chapter_file" .md)
              content=$(cat "$chapter_file")
              CHAPTERS_JSON=$(echo "$CHAPTERS_JSON" | jq --arg slug "$slug" --arg content "$content" '. + [{slug: $slug, content: $content}]')
            fi
          done

          # Determine force flag (from workflow input or default to false)
          # Convert string input to JSON boolean for jq
          if [ "${{ inputs.force }}" = "true" ]; then
            FORCE_JSON="true"
          else
            FORCE_JSON="false"
          fi
          echo "Force flag: $FORCE_JSON"

          # Build full payload
          PAYLOAD=$(jq -n \
            --arg repoName "$REPO_NAME" \
            --arg world "$WORLD_CONTENT" \
            --arg theme "$THEME_CONTENT" \
            --arg arcs "$ARCS_CONTENT" \
            --argjson manifest "$MANIFEST_JSON" \
            --argjson chapters "$CHAPTERS_JSON" \
            --argjson force "$FORCE_JSON" \
            '{repoName: $repoName, world: $world, theme: $theme, arcs: $arcs, manifest: $manifest, chapters: $chapters, force: $force}')

          echo "Publishing $REPO_NAME with $(echo "$CHAPTERS_JSON" | jq 'length') chapters (force: $FORCE_JSON)"

          # POST to backend
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BACKEND_URL/publish" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PUBLISH_API_KEY" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully published chronicle"
          else
            echo "Failed to publish chronicle (HTTP $HTTP_CODE)"
            exit 1
          fi
