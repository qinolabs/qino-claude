name: Build Release Assets

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-assets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build all-tools.zip (manifest-driven)
        run: |
          # Read manifest and copy files dynamically
          # This prevents drift between manifest.json and hardcoded paths

          MANIFEST="tools/manifest.json"
          BUILD_DIR="build/all/qino-claude"

          mkdir -p "$BUILD_DIR"

          # Process each tool in manifest (skip archived tools)
          for tool in $(jq -r '.tools | to_entries[] | select(.value.archived != true) | .key' "$MANIFEST"); do
            echo "Processing: $tool"

            # Copy each file according to manifest
            jq -r --arg tool "$tool" '.tools[$tool].files[] | "\(.src)|\(.dest)"' "$MANIFEST" | while IFS='|' read -r src dest; do
              if [ -f "$src" ]; then
                dest_dir=$(dirname "$BUILD_DIR/$dest")
                mkdir -p "$dest_dir"
                cp "$src" "$BUILD_DIR/$dest"
                echo "  Copied: $dest"
              else
                echo "  Warning: $src not found"
              fi
            done
          done

          # Create zip
          cd build/all
          zip -r ../../all-tools.zip qino-claude
          cd ../..

          echo "Build complete. Contents:"
          find "$BUILD_DIR" -type f | sort

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: all-tools.zip
